import{l as K,k as d,B as A,H as _,z as O,w as Q,J as re,K as ie,o as l,c,a as s,q as L,t as f,x as E,m as F,d as de,r as le,I as ce,b as D,D as q,s as ue,u as he,p as P,A as me,n as ge,G as ve}from"./index-DVbWvh0z.js";import{u as fe,s as ye,e as Y,j as J,a as xe,c as W,d as G,q as be,o as Ie,_ as we,I as N}from"./_plugin-vue_export-helper-CQMwCWeA.js";function Me(){const e=K(),m=d(e.currentUser),{uid:u,photoURL:n,displayName:j}=m.value,M=u,g=d([]),r=JSON.parse(localStorage.getItem("users")).filter(v=>v.id!==M);return g.value=r,{storedUsers:g}}function fs(){const e=K(),m=d(e.currentUser),{firestore:u}=fe(),n=m.value.uid,j=m.value.photoURL,M=m.value.displayName;re();const{storedUsers:g}=Me(),y=d(""),r=d([]),v=d(!1),x=d(!1),S=d(null);let i=d({});const b=(t,a)=>[t,a].sort().join("_"),X=(t,a)=>{document.getElementById(t).showModal(),i.value=a,R(),console.log(r)},Z=async()=>{if(y.value.trim()!==""){x.value=!0;try{const t=b(n,i.value.userId);await ye(Y(u,`chats/${t}`),{participants:{[n]:!0,[i.value.userId]:!0},lastMessage:y.value,sender:n,timestamp:J()},{merge:!0}),await xe(W(u,`chats/${t}/messages`),{senderId:n,recipientId:i.value.userId,message:y.value,timestamp:J()}),x.value=!1}catch(t){console.error("Error sending message: ",t)}y.value=""}},T=d({}),V=d({}),B=d([]),U=d({}),k=d(0),ee=A(()=>g.value.filter(t=>T.value[b(n,t.id)]).sort((t,a)=>{const o=b(n,t.id),I=b(n,a.id);return U.value[I]-U.value[o]})),se=()=>{B.value.forEach(a=>a()),B.value=[];const t=new Set;g.value.forEach(a=>{const o=b(n,a.id),I=Y(u,"chats",o),$=G(I,C=>{if(C.exists()){const h=C.data(),p=h.lastMessage||"",w=h.sender||"",H=h.timestamp||"";T.value[o]=p,V.value[o]=w,U.value[o]=H,p&&w!==n?t.has(w)||(t.add(w),k.value=t.size):t.has(w)&&(t.delete(w),k.value=t.size)}else{T.value[o]="",V.value[o]="",U.value[o]="";const h=V.value[o];t.has(h)&&(t.delete(h),k.value=t.size)}},C=>{console.error("Error listening to chat updates:",C)});B.value.push($)})};_(()=>{se()}),O(()=>{B.value.forEach(t=>t())}),Q(k,t=>{console.log(k.value)});const te=A(()=>r.value.filter(t=>t.senderId===n&&t.recipientId===i.value.userId||t.senderId===i.value.userId&&t.recipientId===n)),ae=()=>{ie(()=>{S.value&&(S.value.scrollTop=S.value.scrollHeight)})},R=()=>{v.value=!0;const t=b(n,i.value.userId),a=be(W(u,`chats/${t}/messages`),Ie("timestamp","asc")),o=G(a,I=>{r.value=I.docs.map($=>({id:$.id,...$.data()})),v.value=!1,ae()});O(()=>{o()})};return _(()=>{R()}),{Time:t=>{if(t){const a=new Date(t.seconds*1e3),o=new Date,I=a.getHours()%12||12,$=("0"+a.getMinutes()).slice(-2),C=a.getHours()<12?"am":"pm",h=`${I}:${$} ${C}`;if(a.toDateString()===o.toDateString())return h;const p=new Date(o);if(p.setDate(p.getDate()-1),a.toDateString()===p.toDateString())return`Yesterday ${h}`;const H=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][a.getDay()],z=new Date(o);if(z.setDate(z.getDate()-7),a>z)return`${H} ${h}`;const ne=a.toLocaleString("default",{month:"short"}),oe=a.getDate();return`${ne} ${oe} ${h}`}return""},getChatId:b,yourChat:X,sendMessage:Z,userId:n,newMessage:y,messages:r,isLoading:v,isSendMessageLoading:x,filteredMessages:te,selectedUser:i,timestamp:U,userPhoto:j,userName:M,filteredUsers:ee,latestMessages:T,isSender:V,storedUsers:g,newMessageArray:k}}const Se={class:"w-10 rounded-full"},ke=["src"],$e={class:""},Ce={class:"text-sm font-medium capitalize"},pe={class:"flex gap-2 justify-start items-center"},De={key:0,class:"text-xs"},Ue={class:"text-[10px]"},ys={__name:"usersChatHeads",props:{yourChat:{type:Function,required:!0},formatTime:{type:Function,required:!0},user:{type:Object,required:!0},latestMessages:{type:Object,required:!0},getChatId:{type:Function,required:!0},userId:{type:[String,Number],required:!0},isSender:{type:Object,required:!0},timestamp:{type:Object,required:!0}},setup(e){return(m,u)=>(l(),c("div",{onClick:u[0]||(u[0]=n=>e.yourChat(e.user)),class:"flex justify-start items-center gap-2 cursor-pointer hover:bg-gray-500/20 transition p-1 rounded-md"},[s("div",{class:L(["avatar",e.user.status==="online"?"online":"offline"])},[s("div",Se,[s("img",{src:e.user.userPhotoURL},null,8,ke)])],2),s("div",$e,[s("h1",Ce,f(e.user.userName),1),s("div",pe,[e.latestMessages[e.getChatId(e.userId,e.user.id)]?(l(),c("span",{key:0,class:L(["text-xs px-2 py-0.5 bg-gray-500/20 rounded-full",e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?"":"text-blue-500"])},[e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?(l(),c("span",De," You: ")):E("",!0),F(" "+f(e.latestMessages[e.getChatId(e.userId,e.user.id)]),1)],2)):E("",!0),s("span",Ue,f(e.formatTime(e.timestamp[e.getChatId(e.userId,e.user.id)])),1)])])]))}},qe={},Ne={class:"my-3"},Le=de('<div class="flex flex-col gap-4 w-32 ml-2"><div class="flex gap-2 items-center"><div class="skeleton w-10 h-10 rounded-full shrink-0"></div><div class="flex flex-col gap-2"><div class="skeleton h-2 w-10"></div><div class="skeleton h-2 w-20"></div></div></div></div><div class="flex justify-end mr-5"><div class="flex flex-col gap-4 w-32"><div class="flex gap-2 items-center"><div class="flex flex-col gap-2"><div class="skeleton h-2 w-20"></div><div class="skeleton h-2 w-10"></div></div><div class="skeleton w-10 h-10 rounded-full shrink-0"></div></div></div></div>',2),je=[Le];function Te(e,m){return l(),c("div",Ne,je)}const Ve=we(qe,[["render",Te]]),Be={class:"modal-box relative pb-4 pt-2 px-2"},Ee={class:"modal-action absolute z-10 -top-4 right-2"},He={method:"dialog"},ze={class:"btn btn-xs px-0.5 rounded-full"},Fe={class:"flex justify-start items-center gap-2"},Re={class:"avatar"},Ae={class:"w-10 rounded-full"},_e=["src"],Oe={class:"text-sm font-medium"},Pe=s("hr",{class:"my-1 border border-gray-400/20"},null,-1),Ye={key:0,class:"my-2 flex justify-center items-center text-sm"},Je={class:"py-1 px-4 bg-primary/10 rounded-full"},We={class:"text-primary font-semibold"},Ge={class:"chat-image avatar"},Ke={class:"w-10 rounded-full"},Qe=["src"],Xe=["src"],Ze={class:"chat-header text-xs font-medium"},es={class:"text-[10px] opacity-50"},ss={class:"chat-footer opacity-50 font-semibold text-xs"},ts={key:1},as={class:"my-1 flex justify-start items-center gap-2 bg-gray-400/20 shadow rounded-2xl"},ns={class:"w-full"},os=["disabled","value"],rs={class:"flex justify-between items-center m-3 h-5"},is={class:"flex justify-center items-center gap-1"},ds={disabled:"",class:"transition cursor-not-allowed p-1 rounded-full bg-gray-400/20 hover:text-success shadow"},ls={disabled:"",class:"transition cursor-not-allowed p-1 rounded-full bg-gray-400/20 hover:text-secondary shadow"},cs={key:1,class:"cursor-not-allowed",disabled:""},us=10,hs=24,xs={__name:"ChatModal",props:{userId:{type:String,required:!0},messages:{type:Array,required:!0},selectedUser:{type:Object,required:!0},userPhoto:{type:String,required:!0},userName:{type:String,required:!0},isSendMessageLoading:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},formatTime:{type:Function,required:!0},sendMessage:{type:Function,required:!0},filteredMessages:{type:Array},modelValue:{type:String,required:!0}},emits:["update:modelValue"],setup(e,{emit:m}){const u=e,n=m,j=d(null),M=d(null),g=()=>{const r=M.value;if(r){r.style.height="auto";const v=r.scrollHeight,x=us*hs;v>x?(r.style.height=`${x}px`,r.style.overflowY="auto"):r.style.height=`${v}px`}},y=r=>{n("update:modelValue",r.target.value),g()};return Q(u.modelValue,()=>{g()}),(r,v)=>{const x=le("botton"),S=ce("motion-fade");return l(),c("div",Be,[s("div",Ee,[s("form",He,[s("button",ze,[D(q(N),{icon:"carbon:close",class:"text-xl text-red-500"})])])]),s("div",Fe,[s("div",Re,[s("div",Ae,[s("img",{src:e.selectedUser.userPhotoURL},null,8,_e)])]),s("div",null,[s("h1",Oe,f(e.selectedUser.userName),1)])]),Pe,s("div",{class:"h-80 rounded-md overflow-y-scroll",ref_key:"messageContainer",ref:j},[e.filteredMessages.length===0&&!e.isLoading?(l(),c("div",Ye,[s("span",Je,[F("No conversation with "),s("span",We,f(e.selectedUser.userName),1)])])):E("",!0),(l(!0),c(ue,null,he(e.filteredMessages,i=>(l(),c("div",{key:i.id},[s("div",{class:L(["chat",i.senderId===e.userId?"chat-end":"chat-start"])},[s("div",Ge,[s("div",Ke,[e.userId===i.senderId?(l(),c("img",{key:0,src:e.userPhoto},null,8,Qe)):(l(),c("img",{key:1,src:e.selectedUser.userPhotoURL},null,8,Xe))])]),s("div",Ze,[F(f(i.senderId===e.userId?e.userName:e.selectedUser.userName)+" ",1),s("time",es,f(e.formatTime(i.timestamp)),1)]),s("div",{class:L(["chat-bubble text-sm",e.userId===i.senderId?"chat-bubble-primary":""])},f(i.message),3),s("div",ss,f(e.isSendMessageLoading?"Sending... bugs, hehehe":"Delivered"),1)],2)]))),128)),e.isLoading?(l(),c("div",ts,[D(Ve)])):E("",!0)],512),s("form",null,[s("div",as,[s("div",ns,[s("textarea",{type:"text",disabled:e.isSendMessageLoading,cols:"1",rows:"1",required:"",ref_key:"autoExpand",ref:M,value:e.modelValue,onInput:y,placeholder:"Enter a message",class:"w-full px-3 pt-3 placeholder:text-sm resize-none rounded-2xl no-scrollbar bg-transparent outline-none"},null,40,os),s("div",rs,[s("div",is,[s("button",ds,[D(q(N),{icon:"tabler:photo",class:"text-xl"})]),s("button",ls,[D(q(N),{icon:"tabler:file",class:"text-xl"})])]),s("div",{class:L(["rounded-full p-1.5 flex shadow justify-center transition items-center",e.modelValue!==""?"bg-blue-500 hover:bg-blue-500/90 ":"bg-primary/10 hover:bg-primary/20"])},[!e.isSendMessageLoading&&e.modelValue?P((l(),me(x,{key:0,onClick:ge(e.sendMessage,["prevent"])},{default:ve(()=>[D(q(N),{icon:"bxs:send",class:"text-xl text-gray-200"})]),_:1},8,["onClick"])),[[S]]):P((l(),c("button",cs,[D(q(N),{icon:"ic:round-mic",class:"text-xl text-primary"})])),[[S]])],2)])])])])])}}};export{fs as C,ys as _,xs as a};
