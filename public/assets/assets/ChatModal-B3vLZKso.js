import{l as K,k as i,B as A,H as O,z as P,w as Q,J as oe,K as re,o as l,c,a as t,q as B,t as x,x as D,m as F,d as de,b as U,D as j,s as ie,u as le,G as ce,T as ue,n as he}from"./index-3AW_b8g7.js";import{u as me,s as ge,e as Y,j as J,a as ve,c as W,d as G,q as fe,o as ye,_ as xe,I as V}from"./_plugin-vue_export-helper-BdyQwLWd.js";function be(){const e=K(),g=i(e.currentUser),{uid:u,photoURL:n,displayName:N}=g.value,M=u,v=i([]),r=JSON.parse(localStorage.getItem("users")).filter(h=>h.id!==M);return v.value=r,{storedUsers:v}}function hs(){const e=K(),g=i(e.currentUser),{firestore:u}=me(),n=g.value.uid,N=g.value.photoURL,M=g.value.displayName;oe();const{storedUsers:v}=be(),f=i(""),r=i([]),h=i(!1),d=i(!1),E=i(null);let y=i({});const b=(s,a)=>[s,a].sort().join("_"),X=(s,a)=>{document.getElementById(s).showModal(),y.value=a,R(),console.log(r)},Z=async()=>{if(f.value.trim()!==""){d.value=!0;try{const s=b(n,y.value.userId);await ge(Y(u,`chats/${s}`),{participants:{[n]:!0,[y.value.userId]:!0},lastMessage:f.value,sender:n,timestamp:J()},{merge:!0}),await ve(W(u,`chats/${s}/messages`),{senderId:n,recipientId:y.value.userId,message:f.value,timestamp:J()}),d.value=!1}catch(s){console.error("Error sending message: ",s)}f.value=""}},p=i({}),L=i({}),T=i([]),q=i({}),S=i(0),_=A(()=>v.value.filter(s=>p.value[b(n,s.id)]).sort((s,a)=>{const o=b(n,s.id),I=b(n,a.id);return q.value[I]-q.value[o]})),ee=()=>{T.value.forEach(a=>a()),T.value=[];const s=new Set;v.value.forEach(a=>{const o=b(n,a.id),I=Y(u,"chats",o),$=G(I,k=>{if(k.exists()){const m=k.data(),C=m.lastMessage||"",w=m.sender||"",H=m.timestamp||"";p.value[o]=C,L.value[o]=w,q.value[o]=H,C&&w!==n?s.has(w)||(s.add(w),S.value=s.size):s.has(w)&&(s.delete(w),S.value=s.size)}else{p.value[o]="",L.value[o]="",q.value[o]="";const m=L.value[o];s.has(m)&&(s.delete(m),S.value=s.size)}},k=>{console.error("Error listening to chat updates:",k)});T.value.push($)})};O(()=>{ee()}),P(()=>{T.value.forEach(s=>s())}),Q(S,s=>{console.log(S.value)});const se=A(()=>r.value.filter(s=>s.senderId===n&&s.recipientId===y.value.userId||s.senderId===y.value.userId&&s.recipientId===n)),te=()=>{re(()=>{E.value&&(E.value.scrollTop=E.value.scrollHeight)})},R=()=>{h.value=!0;const s=b(n,y.value.userId),a=fe(W(u,`chats/${s}/messages`),ye("timestamp","asc")),o=G(a,I=>{r.value=I.docs.map($=>({id:$.id,...$.data()})),h.value=!1,te()});P(()=>{o()})};return O(()=>{R()}),{Time:s=>{if(s){const a=new Date(s.seconds*1e3),o=new Date,I=a.getHours()%12||12,$=("0"+a.getMinutes()).slice(-2),k=a.getHours()<12?"am":"pm",m=`${I}:${$} ${k}`;if(a.toDateString()===o.toDateString())return m;const C=new Date(o);if(C.setDate(C.getDate()-1),a.toDateString()===C.toDateString())return`Yesterday ${m}`;const H=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][a.getDay()],z=new Date(o);if(z.setDate(z.getDate()-7),a>z)return`${H} ${m}`;const ae=a.toLocaleString("default",{month:"short"}),ne=a.getDate();return`${ae} ${ne} ${m}`}return""},getChatId:b,yourChat:X,sendMessage:Z,userId:n,newMessage:f,messages:r,isLoading:h,isSendMessageLoading:d,filteredMessages:se,selectedUser:y,timestamp:q,userPhoto:N,userName:M,filteredUsers:_,latestMessages:p,isSender:L,storedUsers:v,newMessageArray:S}}const Ie={class:"w-10 rounded-full"},we=["src"],Me={class:""},Se={class:"text-sm font-medium capitalize"},$e={class:"flex gap-2 justify-start items-center"},ke={key:0,class:"text-xs"},Ce={class:"text-[10px]"},ms={__name:"usersChatHeads",props:{yourChat:{type:Function,required:!0},formatTime:{type:Function,required:!0},user:{type:Object,required:!0},latestMessages:{type:Object,required:!0},getChatId:{type:Function,required:!0},userId:{type:[String,Number],required:!0},isSender:{type:Object,required:!0},timestamp:{type:Object,required:!0}},setup(e){return(g,u)=>(l(),c("div",{onClick:u[0]||(u[0]=n=>e.yourChat(e.user)),class:"flex justify-start items-center gap-2 cursor-pointer hover:bg-gray-500/20 transition p-1 rounded-md"},[t("div",{class:B(["avatar",e.user.status==="online"?"online":"offline"])},[t("div",Ie,[t("img",{src:e.user.userPhotoURL},null,8,we)])],2),t("div",Me,[t("h1",Se,x(e.user.userName),1),t("div",$e,[e.latestMessages[e.getChatId(e.userId,e.user.id)]?(l(),c("span",{key:0,class:B(["text-xs px-2 py-0.5 bg-gray-500/20 rounded-full",e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?"":"text-blue-500"])},[e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?(l(),c("span",ke," You: ")):D("",!0),F(" "+x(e.latestMessages[e.getChatId(e.userId,e.user.id)]),1)],2)):D("",!0),t("span",Ce,x(e.formatTime(e.timestamp[e.getChatId(e.userId,e.user.id)])),1)])])]))}},Ue={},qe={class:"my-3"},De=de('<div class="flex flex-col gap-4 w-32 ml-2"><div class="flex gap-2 items-center"><div class="skeleton w-10 h-10 rounded-full shrink-0"></div><div class="flex flex-col gap-2"><div class="skeleton h-2 w-10"></div><div class="skeleton h-2 w-20"></div></div></div></div><div class="flex justify-end mr-5"><div class="flex flex-col gap-4 w-32"><div class="flex gap-2 items-center"><div class="flex flex-col gap-2"><div class="skeleton h-2 w-20"></div><div class="skeleton h-2 w-10"></div></div><div class="skeleton w-10 h-10 rounded-full shrink-0"></div></div></div></div>',2),Ne=[De];function pe(e,g){return l(),c("div",qe,Ne)}const Le=xe(Ue,[["render",pe]]),Te={class:"modal-box relative pb-4 pt-2 px-2"},je={class:"modal-action absolute z-10 -top-4 right-2"},Ve={method:"dialog"},Be={class:"btn btn-xs px-0.5 rounded-full"},Ee={class:"flex justify-start items-center gap-2"},He={class:"avatar"},ze={class:"w-10 rounded-full"},Fe=["src"],Re={class:"text-sm font-medium"},Ae=t("hr",{class:"my-1 border border-gray-400/20"},null,-1),Oe={key:0,class:"my-2 flex justify-center items-center text-sm"},Pe={class:"py-1 px-4 bg-primary/10 rounded-full"},Ye={class:"text-primary font-semibold"},Je={class:"chat-image avatar"},We={class:"w-10 rounded-full"},Ge=["src"],Ke=["src"],Qe={class:"chat-header text-xs font-medium"},Xe={class:"text-[10px] opacity-50"},Ze={key:1},_e={class:"my-1 flex justify-start items-center gap-2 bg-gray-400/20 shadow rounded-2xl"},es={class:"w-full"},ss=["disabled","value"],ts={class:"flex justify-between items-center m-3 h-5"},as={class:"flex justify-center items-center gap-1"},ns={disabled:"",class:"transition cursor-not-allowed p-1 rounded-full bg-gray-400/20 hover:text-success shadow"},os={disabled:"",class:"transition cursor-not-allowed p-1 rounded-full bg-gray-400/20 hover:text-secondary shadow"},rs={key:0,class:"rounded-full p-1.5 bg-blue-500"},ds=10,is=24,gs={__name:"ChatModal",props:{userId:{type:String,required:!0},messages:{type:Array,required:!0},selectedUser:{type:Object,required:!0},userPhoto:{type:String,required:!0},userName:{type:String,required:!0},isSendMessageLoading:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},formatTime:{type:Function,required:!0},sendMessage:{type:Function,required:!0},filteredMessages:{type:Array},modelValue:{type:String,required:!0}},emits:["update:modelValue"],setup(e,{emit:g}){const u=e,n=g,N=i(null),M=i(null),v=()=>{const r=M.value;if(r){r.style.height="auto";const h=r.scrollHeight,d=ds*is;h>d?(r.style.height=`${d}px`,r.style.overflowY="auto"):r.style.height=`${h}px`}},f=r=>{n("update:modelValue",r.target.value),v()};return Q(u.modelValue,()=>{v()}),(r,h)=>(l(),c("div",Te,[t("div",je,[t("form",Ve,[t("button",Be,[U(j(V),{icon:"carbon:close",class:"text-xl text-red-500"})])])]),t("div",Ee,[t("div",He,[t("div",ze,[t("img",{src:e.selectedUser.userPhotoURL},null,8,Fe)])]),t("div",null,[t("h1",Re,x(e.selectedUser.userName),1)])]),Ae,t("div",{class:"h-80 rounded-md overflow-y-scroll",ref_key:"messageContainer",ref:N},[e.filteredMessages.length===0&&!e.isLoading?(l(),c("div",Oe,[t("span",Pe,[F("No conversation with "),t("span",Ye,x(e.selectedUser.userName),1)])])):D("",!0),(l(!0),c(ie,null,le(e.filteredMessages,d=>(l(),c("div",{key:d.id},[t("div",{class:B(["chat",d.senderId===e.userId?"chat-end":"chat-start"])},[t("div",Je,[t("div",We,[e.userId===d.senderId?(l(),c("img",{key:0,src:e.userPhoto},null,8,Ge)):(l(),c("img",{key:1,src:e.selectedUser.userPhotoURL},null,8,Ke))])]),t("div",Qe,[F(x(d.senderId===e.userId?e.userName:e.selectedUser.userName)+" ",1),t("time",Xe,x(e.formatTime(d.timestamp)),1)]),t("div",{class:B(["chat-bubble text-sm",e.userId===d.senderId?"chat-bubble-primary":""])},x(d.message),3)],2)]))),128)),e.isLoading?(l(),c("div",Ze,[U(Le)])):D("",!0)],512),t("form",{onSubmit:h[0]||(h[0]=he((...d)=>e.sendMessage&&e.sendMessage(...d),["prevent"]))},[t("div",_e,[t("div",es,[t("textarea",{type:"text",disabled:e.isSendMessageLoading,cols:"1",rows:"1",required:"",ref_key:"autoExpand",ref:M,value:e.modelValue,onInput:f,placeholder:"Enter a message",class:"w-full px-3 pt-3 placeholder:text-sm resize-none rounded-2xl no-scrollbar bg-transparent outline-none"},null,40,ss),t("div",ts,[t("div",as,[t("button",ns,[U(j(V),{icon:"tabler:photo",class:"text-xl"})]),t("button",os,[U(j(V),{icon:"tabler:file",class:"text-xl"})])]),U(ue,null,{default:ce(()=>[!e.isSendMessageLoading&&e.modelValue?(l(),c("button",rs,[U(j(V),{icon:"bxs:send",class:"text-xl text-gray-100"})])):D("",!0)]),_:1})])])])],32)]))}};export{hs as C,ms as _,gs as a};
