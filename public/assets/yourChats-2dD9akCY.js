import{o as l,c as d,d as ae,l as oe,k as c,H as ne,E as R,z as V,I as le,s as q,u as z,D as o,a as e,b as U,t as v,m as C,x as _,n as de,p as ie,v as re,q as f,J as ce}from"./index-BPUH1O6b.js";import{I as H}from"./iconify-DlN6m1Cd.js";import{g as ue}from"./getUsers-CZo5MH6X.js";import{_ as ve,u as me,e as P,d as A,q as he,o as _e,c as F,s as ge,j as W,a as fe}from"./_plugin-vue_export-helper-AFu1rJK7.js";const pe={},xe={class:"my-3"},ye=ae('<div class="flex flex-col gap-4 w-32 ml-2"><div class="flex gap-2 items-center"><div class="skeleton w-10 h-10 rounded-full shrink-0"></div><div class="flex flex-col gap-2"><div class="skeleton h-2 w-10"></div><div class="skeleton h-2 w-20"></div></div></div></div><div class="flex justify-end mr-5"><div class="flex flex-col gap-4 w-32"><div class="flex gap-2 items-center"><div class="flex flex-col gap-2"><div class="skeleton h-2 w-20"></div><div class="skeleton h-2 w-10"></div></div><div class="skeleton w-10 h-10 rounded-full shrink-0"></div></div></div></div>',2),be=[ye];function Ie(Y,L){return l(),d("div",xe,be)}const ke=ve(pe,[["render",Ie]]),we=["onClick"],De={class:"w-10 rounded-full"},$e=["src"],Me={class:""},Ne={class:"text-sm font-medium capitalize"},Se={class:"flex gap-2 justify-start items-center"},Ue={key:0,class:"text-xs"},Ce={class:"text-xs"},Le={id:"openInbox",class:"modal modal-bottom sm:modal-middle"},Ee={class:"modal-box relative pb-4 pt-2 px-2"},Te={class:"modal-action absolute z-10 -top-4 right-2"},je={method:"dialog"},Be={class:"btn btn-xs px-0.5 rounded-full"},Re={class:"flex justify-start items-center gap-2"},Ve={class:"avatar"},qe={class:"w-10 rounded-full"},ze=["src"],He={class:"text-sm font-medium"},Pe=e("hr",{class:"my-1 border border-gray-400/20"},null,-1),Ae={key:0,class:"my-2 flex justify-center items-center text-sm"},Fe={class:"py-1 px-4 bg-primary/10 rounded-full"},We={class:"text-primary font-semibold"},Ye={class:"chat-image avatar"},Je={class:"w-10 rounded-full"},Qe=["src"],Ge=["src"],Ke={class:"chat-header text-xs font-medium"},Oe={class:"text-[10px] opacity-50"},Xe={key:1},Ze={class:"my-1 flex justify-start items-center gap-2"},es=["disabled"],ss={key:0,class:"loading loading-ring loading-lg"},ds={__name:"yourChats",setup(Y){const L=oe(),$=c(L.currentUser),{firestore:p}=me(),n=$.value.uid,J=$.value.photoURL,Q=$.value.displayName;ne();const{storedUsers:E}=ue();let i=c({});const m=c(""),x=c([]),y=c(!1),g=c(!1),b=c(null),G=t=>{document.getElementById("openInbox").showModal(),i.value=t,B(),console.log(x)},K=async()=>{if(m.value.trim()!==""){g.value=!0;try{const t=u(n,i.value.userId);await ge(P(p,`chats/${t}`),{participants:{[n]:!0,[i.value.userId]:!0},lastMessage:m.value,sender:n,timestamp:W()},{merge:!0}),await fe(F(p,`chats/${t}/messages`),{senderId:n,recipientId:i.value.userId,message:m.value,timestamp:W()}),g.value=!1}catch(t){console.error("Error sending message: ",t)}m.value=""}},u=(t,a)=>[t,a].sort().join("_"),I=c({}),k=c({}),w=c([]),M=c({}),O=()=>{w.value.forEach(t=>t()),w.value=[],E.value.forEach(t=>{const a=u(n,t.id),s=P(p,"chats",a),h=A(s,r=>{r.exists()?(I.value[a]=r.data().lastMessage||"",k.value[a]=r.data().sender||"",M.value[a]=r.data().timestamp||""):(I.value[a]="",k.value[a]="",M.value[a]="")},r=>{console.error("Error listening to chat updates:",r)});w.value.push(h)})};R(()=>{O()}),V(()=>{w.value.forEach(t=>t())});const T=le(()=>x.value.filter(t=>t.senderId===n&&t.recipientId===i.value.userId||t.senderId===i.value.userId&&t.recipientId===n));console.log(x);const j=t=>{if(t){const a=new Date(t.seconds*1e3),s=new Date,h=a.getHours()%12||12,r=("0"+a.getMinutes()).slice(-2),Z=a.getHours()<12?"am":"pm",D=`${h}:${r} ${Z}`;if(a.toDateString()===s.toDateString())return D;const N=new Date(s);if(N.setDate(N.getDate()-1),a.toDateString()===N.toDateString())return`Yesterday ${D}`;const ee=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][a.getDay()],S=new Date(s);if(S.setDate(S.getDate()-7),a>S)return`${ee} ${D}`;const se=a.toLocaleString("default",{month:"short"}),te=a.getDate();return`${se} ${te} ${D}`}return""},X=()=>{ce(()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)})},B=()=>{y.value=!0;const t=u(n,i.value.userId),a=he(F(p,`chats/${t}/messages`),_e("timestamp","asc")),s=A(a,h=>{x.value=h.docs.map(r=>({id:r.id,...r.data()})),y.value=!1,X()});V(()=>{s()})};return R(()=>{B()}),(t,a)=>(l(),d("div",null,[(l(!0),d(q,null,z(o(E),s=>(l(),d("div",{key:s.id},[e("div",{onClick:h=>G(s),class:"flex justify-start items-center gap-2 cursor-pointer hover:bg-gray-500/20 transition p-1 rounded-md"},[e("div",{class:f(["avatar",s.status==="online"?"online":"offline"])},[e("div",De,[e("img",{src:s.userPhotoURL},null,8,$e)])],2),e("div",Me,[e("h1",Ne,v(s.userName),1),e("div",Se,[I.value[u(o(n),s.id)]?(l(),d("span",{key:0,class:f(["text-xs px-2 py-0.5 bg-gray-500/20 rounded-full",k.value[u(o(n),s.id)]===o(n)?"":"text-blue-500"])},[k.value[u(o(n),s.id)]===o(n)?(l(),d("span",Ue," You: ")):_("",!0),C(" "+v(I.value[u(o(n),s.id)]),1)],2)):_("",!0),e("span",Ce,v(j(M.value[u(o(n),s.id)])),1)])])],8,we)]))),128)),e("dialog",Le,[e("div",Ee,[e("div",Te,[e("form",je,[e("button",Be,[U(o(H),{icon:"carbon:close",class:"text-xl text-red-500"})])])]),e("div",Re,[e("div",Ve,[e("div",qe,[e("img",{src:o(i).userPhotoURL},null,8,ze)])]),e("div",null,[e("h1",He,v(o(i).userName),1)])]),Pe,e("div",{class:"h-80 rounded-md overflow-y-scroll",ref_key:"messageContainer",ref:b},[T.value.length===0&&!y.value?(l(),d("div",Ae,[e("span",Fe,[C("No conversation with "),e("span",We,v(o(i).userName),1)])])):_("",!0),(l(!0),d(q,null,z(T.value,s=>(l(),d("div",{key:s.id},[e("div",{class:f(["chat",s.senderId===o(n)?"chat-end":"chat-start"])},[e("div",Ye,[e("div",Je,[o(n)===s.senderId?(l(),d("img",{key:0,src:o(J)},null,8,Qe)):(l(),d("img",{key:1,src:o(i).userPhotoURL},null,8,Ge))])]),e("div",Ke,[C(v(s.senderId===o(n)?o(Q):o(i).userName)+" ",1),e("time",Oe,v(j(s.timestamp)),1)]),e("div",{class:f(["chat-bubble text-sm",o(n)===s.senderId?"chat-bubble-primary":""])},v(s.message),3)],2)]))),128)),y.value?(l(),d("div",Xe,[U(ke)])):_("",!0)],512),e("form",{onSubmit:de(K,["prevent"])},[e("div",Ze,[ie(e("input",{type:"text",disabled:g.value,required:"","onUpdate:modelValue":a[0]||(a[0]=s=>m.value=s),placeholder:"Enter a message..",class:"input input-bordered w-full placeholder:text-sm rounded-full"},null,8,es),[[re,m.value]]),g.value?(l(),d("span",ss)):_("",!0),g.value?_("",!0):(l(),d("button",{key:1,class:f(["rounded-full btn transition",m.value===""?"hidden":""])},[U(o(H),{icon:"bxs:send",class:"text-xl text-blue-500"})],2))])],32)])])]))}};export{ds as default};
