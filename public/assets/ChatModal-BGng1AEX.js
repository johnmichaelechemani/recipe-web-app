import{l as W,k as r,B as F,H as R,z as O,w as ae,J as ne,K as re,o as i,c as o,a as s,q as S,t as h,x,m as B,d as de,b as V,D as P,s as ie,u as oe,n as le}from"./index-Dt8P8cwA.js";import{u as ue,s as ce,e as A,j as H,a as me,c as z,d as p,q as ge,o as he,_ as ve,I as J}from"./_plugin-vue_export-helper-BIgm_SCi.js";function fe(){const e=W(),c=r(e.currentUser),{uid:l,photoURL:n,displayName:d}=c.value,U=l,v=r([]),y=JSON.parse(localStorage.getItem("users")).filter(I=>I.id!==U);return v.value=y,{storedUsers:v}}function as(){const e=W(),c=r(e.currentUser),{firestore:l}=ue(),n=c.value.uid,d=c.value.photoURL,U=c.value.displayName;ne();const{storedUsers:v}=fe(),f=r(""),y=r([]),I=r(!1),q=r(!1),D=r(null);let m=r({});const b=(t,a)=>[t,a].sort().join("_"),Y=(t,a)=>{document.getElementById(t).showModal(),m.value=a,E(),console.log(y)},K=async()=>{if(f.value.trim()!==""){q.value=!0;try{const t=b(n,m.value.userId);await ce(A(l,`chats/${t}`),{participants:{[n]:!0,[m.value.userId]:!0},lastMessage:f.value,sender:n,timestamp:H()},{merge:!0}),await me(z(l,`chats/${t}/messages`),{senderId:n,recipientId:m.value.userId,message:f.value,timestamp:H()}),q.value=!1}catch(t){console.error("Error sending message: ",t)}f.value=""}},M=r({}),$=r({}),k=r([]),L=r({}),N=r(0),Q=F(()=>v.value.filter(t=>M.value[b(n,t.id)])),G=()=>{k.value.forEach(t=>t()),k.value=[],v.value.forEach(t=>{const a=b(n,t.id),g=A(l,"chats",a),w=p(g,u=>{u.exists()?(M.value[a]=u.data().lastMessage||"",$.value[a]=u.data().sender||"",L.value[a]=u.data().timestamp||"",M.value[a]&&$.value[a]!==n&&N.value++):(M.value[a]="",$.value[a]="",L.value[a]="")},u=>{console.error("Error listening to chat updates:",u)});k.value.push(w)})};R(()=>{G()}),O(()=>{k.value.forEach(t=>t())}),ae(N,t=>{console.log(N.value)});const X=F(()=>y.value.filter(t=>t.senderId===n&&t.recipientId===m.value.userId||t.senderId===m.value.userId&&t.recipientId===n)),Z=()=>{re(()=>{D.value&&(D.value.scrollTop=D.value.scrollHeight)})},E=()=>{I.value=!0;const t=b(n,m.value.userId),a=ge(z(l,`chats/${t}/messages`),he("timestamp","asc")),g=p(a,w=>{y.value=w.docs.map(u=>({id:u.id,...u.data()})),I.value=!1,Z()});O(()=>{g()})};return R(()=>{E()}),{Time:t=>{if(t){const a=new Date(t.seconds*1e3),g=new Date,w=a.getHours()%12||12,u=("0"+a.getMinutes()).slice(-2),_=a.getHours()<12?"am":"pm",C=`${w}:${u} ${_}`;if(a.toDateString()===g.toDateString())return C;const j=new Date(g);if(j.setDate(j.getDate()-1),a.toDateString()===j.toDateString())return`Yesterday ${C}`;const ee=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][a.getDay()],T=new Date(g);if(T.setDate(T.getDate()-7),a>T)return`${ee} ${C}`;const se=a.toLocaleString("default",{month:"short"}),te=a.getDate();return`${se} ${te} ${C}`}return""},getChatId:b,yourChat:Y,sendMessage:K,userId:n,newMessage:f,messages:y,isLoading:I,isSendMessageLoading:q,filteredMessages:X,selectedUser:m,timestamp:L,userPhoto:d,userName:U,filteredUsers:Q,latestMessages:M,isSender:$,storedUsers:v}}const ye={class:"w-10 rounded-full"},xe=["src"],Ie={class:""},be={class:"text-sm font-medium capitalize"},Me={class:"flex gap-2 justify-start items-center"},we={key:0,class:"text-xs"},Se={class:"text-[10px]"},ns={__name:"usersChatHeads",props:{yourChat:{type:Function,required:!0},formatTime:{type:Function,required:!0},user:{type:Object,required:!0},latestMessages:{type:Object,required:!0},getChatId:{type:Function,required:!0},userId:{type:[String,Number],required:!0},isSender:{type:Object,required:!0},timestamp:{type:Object,required:!0}},setup(e){return(c,l)=>(i(),o("div",{onClick:l[0]||(l[0]=n=>e.yourChat(e.user)),class:"flex justify-start items-center gap-2 cursor-pointer hover:bg-gray-500/20 transition p-1 rounded-md"},[s("div",{class:S(["avatar",e.user.status==="online"?"online":"offline"])},[s("div",ye,[s("img",{src:e.user.userPhotoURL},null,8,xe)])],2),s("div",Ie,[s("h1",be,h(e.user.userName),1),s("div",Me,[e.latestMessages[e.getChatId(e.userId,e.user.id)]?(i(),o("span",{key:0,class:S(["text-xs px-2 py-0.5 bg-gray-500/20 rounded-full",e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?"":"text-blue-500"])},[e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?(i(),o("span",we," You: ")):x("",!0),B(" "+h(e.latestMessages[e.getChatId(e.userId,e.user.id)]),1)],2)):x("",!0),s("span",Se,h(e.formatTime(e.timestamp[e.getChatId(e.userId,e.user.id)])),1)])])]))}},$e={},ke={class:"my-3"},Ce=de('<div class="flex flex-col gap-4 w-32 ml-2"><div class="flex gap-2 items-center"><div class="skeleton w-10 h-10 rounded-full shrink-0"></div><div class="flex flex-col gap-2"><div class="skeleton h-2 w-10"></div><div class="skeleton h-2 w-20"></div></div></div></div><div class="flex justify-end mr-5"><div class="flex flex-col gap-4 w-32"><div class="flex gap-2 items-center"><div class="flex flex-col gap-2"><div class="skeleton h-2 w-20"></div><div class="skeleton h-2 w-10"></div></div><div class="skeleton w-10 h-10 rounded-full shrink-0"></div></div></div></div>',2),Ue=[Ce];function qe(e,c){return i(),o("div",ke,Ue)}const De=ve($e,[["render",qe]]),Le={class:"modal-box relative pb-4 pt-2 px-2"},Ne={class:"modal-action absolute z-10 -top-4 right-2"},je={method:"dialog"},Te={class:"btn btn-xs px-0.5 rounded-full"},Ve={class:"flex justify-start items-center gap-2"},Be={class:"avatar"},Ee={class:"w-10 rounded-full"},Fe=["src"],Re={class:"text-sm font-medium"},Oe=s("hr",{class:"my-1 border border-gray-400/20"},null,-1),Pe={key:0,class:"my-2 flex justify-center items-center text-sm"},Ae={class:"py-1 px-4 bg-primary/10 rounded-full"},He={class:"text-primary font-semibold"},ze={class:"chat-image avatar"},pe={class:"w-10 rounded-full"},Je=["src"],We=["src"],Ye={class:"chat-header text-xs font-medium"},Ke={class:"text-[10px] opacity-50"},Qe={key:1},Ge={class:"my-1 flex justify-start items-center gap-2"},Xe=["disabled","value"],Ze={key:0,class:"loading loading-ring loading-lg"},rs={__name:"ChatModal",props:{userId:{type:String,required:!0},messages:{type:Array,required:!0},selectedUser:{type:Object,required:!0},userPhoto:{type:String,required:!0},userName:{type:String,required:!0},isSendMessageLoading:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},formatTime:{type:Function,required:!0},sendMessage:{type:Function,required:!0},filteredMessages:{type:Array},modelValue:{type:String,required:!0}},setup(e){const c=r(null);return(l,n)=>(i(),o("div",Le,[s("div",Ne,[s("form",je,[s("button",Te,[V(P(J),{icon:"carbon:close",class:"text-xl text-red-500"})])])]),s("div",Ve,[s("div",Be,[s("div",Ee,[s("img",{src:e.selectedUser.userPhotoURL},null,8,Fe)])]),s("div",null,[s("h1",Re,h(e.selectedUser.userName),1)])]),Oe,s("div",{class:"h-80 rounded-md overflow-y-scroll",ref_key:"messageContainer",ref:c},[e.filteredMessages.length===0&&!e.isLoading?(i(),o("div",Pe,[s("span",Ae,[B("No conversation with "),s("span",He,h(e.selectedUser.userName),1)])])):x("",!0),(i(!0),o(ie,null,oe(e.filteredMessages,d=>(i(),o("div",{key:d.id},[s("div",{class:S(["chat",d.senderId===e.userId?"chat-end":"chat-start"])},[s("div",ze,[s("div",pe,[e.userId===d.senderId?(i(),o("img",{key:0,src:e.userPhoto},null,8,Je)):(i(),o("img",{key:1,src:e.selectedUser.userPhotoURL},null,8,We))])]),s("div",Ye,[B(h(d.senderId===e.userId?e.userName:e.selectedUser.userName)+" ",1),s("time",Ke,h(e.formatTime(d.timestamp)),1)]),s("div",{class:S(["chat-bubble text-sm",e.userId===d.senderId?"chat-bubble-primary":""])},h(d.message),3)],2)]))),128)),e.isLoading?(i(),o("div",Qe,[V(De)])):x("",!0)],512),s("form",{onSubmit:n[1]||(n[1]=le((...d)=>e.sendMessage&&e.sendMessage(...d),["prevent"]))},[s("div",Ge,[s("input",{type:"text",disabled:e.isSendMessageLoading,required:"",value:e.modelValue,onInput:n[0]||(n[0]=d=>l.$emit("update:modelValue",d.target.value)),placeholder:"Enter a message..",class:"input input-bordered w-full placeholder:text-sm rounded-full"},null,40,Xe),e.isSendMessageLoading?(i(),o("span",Ze)):x("",!0),e.isSendMessageLoading?x("",!0):(i(),o("button",{key:1,class:S(["rounded-full btn transition",e.modelValue===""?"hidden":""])},[V(P(J),{icon:"bxs:send",class:"text-xl text-blue-500"})],2))])],32)]))}};export{as as C,ns as _,rs as a};
