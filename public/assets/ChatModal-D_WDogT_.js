import{l as X,k as n,D as O,H as P,B as Y,w as Z,J as re,K as ie,o as d,c,a as s,q as k,t as x,x as T,m as _,d as de,r as le,I as ce,b as D,z as L,s as ue,u as he,p as J,y as me,n as ge,G as ve}from"./index-Ch5mVLk3.js";import{u as fe,s as ye,e as W,j as G,a as xe,c as K,d as Q,q as be,o as Ie,_ as we,I as j}from"./_plugin-vue_export-helper-Bo_H4aXX.js";function ke(){const e=X(),f=n(e.currentUser),{uid:h,photoURL:o,displayName:B}=f.value,S=h,m=n([]),l=JSON.parse(localStorage.getItem("users")).filter(b=>b.id!==S);return m.value=l,{storedUsers:m}}function fs(){const e=X(),f=n(e.currentUser),{firestore:h}=fe(),o=f.value.uid,B=f.value.photoURL,S=f.value.displayName;re();const{storedUsers:m}=ke(),y=n(""),l=n([]),b=n(!1),U=n(!1),q=n(null);let i=n({});const g=(t,a)=>[t,a].sort().join("_"),z=(t,a)=>{document.getElementById(t).showModal(),i.value=a,A(),console.log(l)},V=async()=>{if(y.value.trim()!==""){U.value=!0;try{const t=g(o,i.value.userId);await ye(W(h,`chats/${t}`),{participants:{[o]:!0,[i.value.userId]:!0},lastMessage:y.value,sender:o,timestamp:G()},{merge:!0}),await xe(K(h,`chats/${t}/messages`),{senderId:o,recipientId:i.value.userId,message:y.value,timestamp:G()}),U.value=!1}catch(t){console.error("Error sending message: ",t)}y.value=""}},u=n({}),E=n({}),H=n([]),N=n({}),M=n(0),ee=O(()=>m.value.filter(t=>u.value[g(o,t.id)]).sort((t,a)=>{const r=g(o,t.id),I=g(o,a.id);return N.value[I]-N.value[r]})),se=()=>{H.value.forEach(a=>a()),H.value=[];const t=new Set;m.value.forEach(a=>{const r=g(o,a.id),I=W(h,"chats",r),C=Q(I,$=>{if($.exists()){const v=$.data(),p=v.lastMessage||"",w=v.sender||"",F=v.timestamp||"";u.value[r]=p,E.value[r]=w,N.value[r]=F,p&&w!==o?t.has(w)||(t.add(w),M.value=t.size):t.has(w)&&(t.delete(w),M.value=t.size)}else{u.value[r]="",E.value[r]="",N.value[r]="";const v=E.value[r];t.has(v)&&(t.delete(v),M.value=t.size)}},$=>{console.error("Error listening to chat updates:",$)});H.value.push(C)})};P(()=>{se()}),Y(()=>{H.value.forEach(t=>t())}),Z(M,t=>{console.log(M.value)});const te=O(()=>l.value.filter(t=>t.senderId===o&&t.recipientId===i.value.userId||t.senderId===i.value.userId&&t.recipientId===o)),ae=()=>{ie(()=>{q.value&&(q.value.scrollTop=q.value.scrollHeight)})},A=()=>{b.value=!0;const t=g(o,i.value.userId),a=be(K(h,`chats/${t}/messages`),Ie("timestamp","asc")),r=Q(a,I=>{l.value=I.docs.map(C=>({id:C.id,...C.data()})),b.value=!1,ae()});Y(()=>{r()})};return P(()=>{A()}),{Time:t=>{if(t){const a=new Date(t.seconds*1e3),r=new Date,I=a.getHours()%12||12,C=("0"+a.getMinutes()).slice(-2),$=a.getHours()<12?"am":"pm",v=`${I}:${C} ${$}`;if(a.toDateString()===r.toDateString())return v;const p=new Date(r);if(p.setDate(p.getDate()-1),a.toDateString()===p.toDateString())return`Yesterday ${v}`;const F=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][a.getDay()],R=new Date(r);if(R.setDate(R.getDate()-7),a>R)return`${F} ${v}`;const ne=a.toLocaleString("default",{month:"short"}),oe=a.getDate();return`${ne} ${oe} ${v}`}return""},getChatId:g,yourChat:z,sendMessage:V,userId:o,newMessage:y,messages:l,isLoading:b,isSendMessageLoading:U,filteredMessages:te,selectedUser:i,timestamp:N,userPhoto:B,userName:S,filteredUsers:ee,latestMessages:u,isSender:E,storedUsers:m,newMessageArray:M}}const Se={class:"w-10 rounded-full"},Me=["src"],Ce={class:""},$e={class:"text-sm font-medium capitalize"},pe={class:"flex gap-2 justify-start items-center"},De={key:0,class:"text-xs"},Ue={class:"text-[10px]"},ys={__name:"usersChatHeads",props:{yourChat:{type:Function,required:!0},formatTime:{type:Function,required:!0},user:{type:Object,required:!0},latestMessages:{type:Object,required:!0},getChatId:{type:Function,required:!0},userId:{type:[String,Number],required:!0},isSender:{type:Object,required:!0},timestamp:{type:Object,required:!0}},setup(e){return(f,h)=>(d(),c("div",{onClick:h[0]||(h[0]=o=>e.yourChat(e.user)),class:"flex justify-start items-center gap-2 cursor-pointer hover:bg-gray-500/20 transition p-1 rounded-md"},[s("div",{class:k(["avatar",e.user.status==="online"?"online":"offline"])},[s("div",Se,[s("img",{src:e.user.userPhotoURL},null,8,Me)])],2),s("div",Ce,[s("h1",$e,x(e.user.userName),1),s("div",pe,[e.latestMessages[e.getChatId(e.userId,e.user.id)]?(d(),c("span",{key:0,class:k(["text-xs px-2 py-0.5 bg-gray-500/20 rounded-full",e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?"":"text-blue-500"])},[e.isSender[e.getChatId(e.userId,e.user.id)]===e.userId?(d(),c("span",De," You: ")):T("",!0),_(" "+x(e.latestMessages[e.getChatId(e.userId,e.user.id)]),1)],2)):T("",!0),s("span",Ue,x(e.formatTime(e.timestamp[e.getChatId(e.userId,e.user.id)])),1)])])]))}},qe={},Ne={class:"my-3"},Le=de('<div class="flex flex-col gap-4 w-32 ml-2"><div class="flex gap-2 items-center"><div class="skeleton w-10 h-10 rounded-full shrink-0"></div><div class="flex flex-col gap-2"><div class="skeleton h-2 w-10"></div><div class="skeleton h-2 w-20"></div></div></div></div><div class="flex justify-end mr-5"><div class="flex flex-col gap-4 w-32"><div class="flex gap-2 items-center"><div class="flex flex-col gap-2"><div class="skeleton h-2 w-20"></div><div class="skeleton h-2 w-10"></div></div><div class="skeleton w-10 h-10 rounded-full shrink-0"></div></div></div></div>',2),je=[Le];function Te(e,f){return d(),c("div",Ne,je)}const Be=we(qe,[["render",Te]]),Ve={class:"modal-box relative pb-4 pt-2 px-2"},Ee={class:"modal-action absolute z-10 -top-4 right-2"},He={method:"dialog"},ze={class:"btn btn-xs px-0.5 rounded-full"},Fe={class:"flex justify-start items-center gap-2"},Re={class:"avatar"},_e={class:"w-10 rounded-full"},Ae=["src"],Oe={class:"text-sm font-medium"},Pe=s("hr",{class:"my-1 border border-gray-400/20"},null,-1),Ye={key:0,class:"my-2 flex justify-center items-center text-sm"},Je={class:"py-1 px-4 bg-primary/10 rounded-full"},We={class:"text-primary font-semibold"},Ge={class:"chat-image avatar"},Ke={class:"w-10 rounded-full"},Qe=["src"],Xe=["src"],Ze={class:"chat-header text-xs font-medium"},es={class:"text-[10px] opacity-50"},ss={class:"chat-footer opacity-50 font-semibold text-xs"},ts={key:1},as={class:"w-full"},ns=["disabled","value"],os={class:"flex justify-between items-center m-3 h-5"},rs={class:"flex justify-center items-center gap-1"},is={disabled:"",class:"transition cursor-not-allowed p-1 rounded-full bg-gray-400/20 hover:text-success shadow"},ds={disabled:"",class:"transition cursor-not-allowed p-1 rounded-full bg-gray-400/20 hover:text-secondary shadow"},ls={key:0,class:"text-xs font-medium opacity-60 pl-2"},cs={key:1,class:"cursor-not-allowed",disabled:""},us=10,hs=24,xs={__name:"ChatModal",props:{userId:{type:String,required:!0},messages:{type:Array,required:!0},selectedUser:{type:Object,required:!0},userPhoto:{type:String,required:!0},userName:{type:String,required:!0},isSendMessageLoading:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},formatTime:{type:Function,required:!0},sendMessage:{type:Function,required:!0},filteredMessages:{type:Array},modelValue:{type:String,required:!0}},emits:["update:modelValue"],setup(e,{emit:f}){const h=e,o=f,B=n(null),S=n(null),m=n(!1),y=n(null);y.value;const l=S.value,b=()=>{if(l){l.style.height="auto";const i=l.scrollHeight,g=us*hs;i>g?(l.style.height=`${g}px`,l.style.overflowY="auto"):l.style.height=`${i}px`}},U=i=>{o("update:modelValue",i.target.value),b()};Z(h.modelValue,()=>{b()});const q=()=>{m.value=!0};return(i,g)=>{const z=le("botton"),V=ce("motion-fade");return d(),c("div",Ve,[s("div",Ee,[s("form",He,[s("button",ze,[D(L(j),{icon:"carbon:close",class:"text-xl text-red-500"})])])]),s("div",Fe,[s("div",Re,[s("div",_e,[s("img",{src:e.selectedUser.userPhotoURL},null,8,Ae)])]),s("div",null,[s("h1",Oe,x(e.selectedUser.userName),1)])]),Pe,s("div",{class:"h-80 rounded-md overflow-y-scroll",ref_key:"messageContainer",ref:B},[e.filteredMessages.length===0&&!e.isLoading?(d(),c("div",Ye,[s("span",Je,[_("No conversation with "),s("span",We,x(e.selectedUser.userName),1)])])):T("",!0),(d(!0),c(ue,null,he(e.filteredMessages,u=>(d(),c("div",{key:u.id},[s("div",{class:k(["chat",u.senderId===e.userId?"chat-end":"chat-start"])},[s("div",Ge,[s("div",Ke,[e.userId===u.senderId?(d(),c("img",{key:0,src:e.userPhoto},null,8,Qe)):(d(),c("img",{key:1,src:e.selectedUser.userPhotoURL},null,8,Xe))])]),s("div",Ze,[_(x(u.senderId===e.userId?e.userName:e.selectedUser.userName)+" ",1),s("time",es,x(e.formatTime(u.timestamp)),1)]),s("div",{class:k(["chat-bubble text-sm",e.userId===u.senderId?"chat-bubble-primary":""])},x(u.message),3),s("div",ss,x(e.isSendMessageLoading?"Sending... bugs, hehehe":"Delivered"),1)],2)]))),128)),e.isLoading?(d(),c("div",ts,[D(Be)])):T("",!0)],512),s("form",{ref_key:"messageBoxContainer",ref:y},[s("div",{onClick:q,class:k([m.value?"rounded-2xl":"rounded-full","my-1 flex justify-start items-center gap-2 bg-gray-400/20 shadow"])},[s("div",as,[s("textarea",{type:"text",disabled:e.isSendMessageLoading,cols:"1",rows:"1",required:"",autofocus:"",ref_key:"autoExpand",ref:S,value:e.modelValue,onInput:U,placeholder:"Enter a message",class:k([m.value?"":"hidden","w-full px-3 pt-3 placeholder:text-sm resize-none rounded-2xl no-scrollbar bg-transparent outline-none"])},null,42,ns),s("div",os,[s("div",rs,[s("button",is,[D(L(j),{icon:"tabler:photo",class:"text-xl"})]),s("button",ds,[D(L(j),{icon:"tabler:file",class:"text-xl"})]),m.value?T("",!0):(d(),c("span",ls,"Send a message"))]),s("div",{class:k(["rounded-full p-1.5 flex shadow justify-center transition items-center",e.modelValue!==""?"bg-blue-500 hover:bg-blue-500/90 ":"bg-primary/10 hover:bg-primary/20"])},[!e.isSendMessageLoading&&e.modelValue?J((d(),me(z,{key:0,onClick:ge(e.sendMessage,["prevent"])},{default:ve(()=>[D(L(j),{icon:"bxs:send",class:"text-xl text-gray-200"})]),_:1},8,["onClick"])),[[V]]):J((d(),c("button",cs,[D(L(j),{icon:"ic:round-mic",class:"text-xl text-primary"})])),[[V]])],2)])])],2)],512)])}}};export{fs as C,ys as _,xs as a};
